syntax = "proto3";

package api.webhost;

option go_package = "github.com/bgrewell/dtac-agent/api/grpc/go/webhost";

// WebhostService provides control and telemetry for webhost modules.
service WebhostService {
  // Init: DTAC -> module. Provides listen config, proxy definitions, permissions, and module-specific config.
  rpc Init(WebhostInitRequest) returns (WebhostInitResponse);

  // RequestToken: module -> DTAC. Request JWTs for proxies or upstream calls.
  rpc RequestToken(TokenRequest) returns (TokenResponse);

  // EventStream: bidirectional streaming for logs/events.
  rpc EventStream(stream WebhostEvent) returns (stream WebhostEventAck);
}

// Listen configuration for module HTTP server
message ListenConfig {
  string addr = 1;         // e.g., "127.0.0.1"
  int32 port = 2;          // e.g., 45000
  bool tls = 3;            // whether module should serve TLS (optional)
  string tls_profile = 4;  // optional TLS profile id in DTAC (optional)
}

// Proxy configuration
message ProxyAuth {
  string type = 1; // e.g., "jwt_from_dtac"
  repeated string scopes = 2;
}

message ProxyConfig {
  string id = 1;
  string from_path = 2; // public path on module, e.g., "/api/metrics"
  string target_url = 3; // upstream, e.g., "http://192.168.11.23:8081/api/metrics"
  ProxyAuth auth = 4;
}

// Permission model for module (roles & allowed scopes)
message Permissions {
  repeated string roles = 1;
  repeated string allowed_scopes = 2;
  repeated string default_scopes = 3;
}

// Init request/response
message WebhostInitRequest {
  string module_name = 1;
  ListenConfig listen = 2;
  repeated ProxyConfig proxies = 3;
  Permissions permissions = 4;
  string raw_config_json = 5; // free-form module config
}

message WebhostInitResponse {
  bool ok = 1;
  string message = 2;
}

// Token request/response
message TokenRequest {
  string request_id = 1;
  repeated string scopes = 2;
  string for_proxy_id = 3; // optional context
}

message TokenResponse {
  string request_id = 1;
  string access_token = 2;
  int64 expires_at_epoch = 3;
  string error = 4;
}

// Event / log
message WebhostEvent {
  string type = 1; // "log", "metric", "event"
  string level = 2; // "info", "error", etc.
  string message = 3;
  string json_payload = 4;
}

message WebhostEventAck {
  string ack_id = 1;
}
