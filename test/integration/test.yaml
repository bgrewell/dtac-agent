---
suite: DTAC Agent Integration Tests
nodes:
  - name: localhost
    type: local
    options:
      shell: /bin/bash

  - name: dtac-agent
    type: lxd
    options:
      image: ubuntu:24.04
      type: container
      exec_options:
        shell: /bin/bash

  - name: dtac-client
    type: lxd
    options:
      image: ubuntu:24.04
      type: container
      exec_options:
        shell: /bin/bash

setup:
  - name: install curl
    node: dtac-client
    step:
      type: apt
      options:
        packages:
          - curl

  - name: setup directories
    node: dtac-agent
    step:
      type: execute
      options:
        command: "mkdir -p /opt/dtac/{plugins,bin}"

  - name: copy dtac-agent binary
    node: localhost
    step:
      type: execute
      options:
        command: >
          lxc file push ./bin/dtac-agentd-amd64 dtac-agent/opt/dtac/bin/dtac-agentd
          lxc file push ./bin/plugins/* dtac-agent/opt/dtac/plugins/

tests:
  - name: start service
    node: dtac-agent
    type: execute
    options:
      command: bash -c 'systemctl start dtac-agentd.service'
      evaluate:
        exit_code: 0